#!/bin/bash

set -e

HERE="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
ROOT=$(cd $HERE/../..; pwd)

. $ROOT/deps/readies/shibumi/functions

REDISLABS_DIR=/var/opt/redislabs
USER=`whoami`

VERSION=$(NUMERIC=1 $ROOT/getver)
if [[ -z $VERSION ]]; then
	>&2 echo "Cannot determine module version. Aborting."
	exit 1
fi

if [[ -z $LOCAL ]]; then
	>&2 echo "LOCAL argument undefined. Aborting."
	exit 1
fi

[[ -z $GLOBAL ]] && GLOBAL=$REDISLABS_DIR/modules/rg/$VERSION/deps/python3

if [[ $PYENV_IN_SITU == 1 ]]; then
	$SUDO find $(dirname $GLOBAL) -name $(basename $GLOBAL) -type l -delete
	$SUDO mkdir -p $(dirname $GLOBAL)
	$SUDO chown -R $USER $REDISLABS_DIR
else
	[[ -e $LOCAL ]] && rm -rf $LOCAL
	mkdir -p $LOCAL
	
	$SUDO mkdir -p $(dirname $GLOBAL)
	$SUDO chown -R $USER $REDISLABS_DIR
	if [[ ! -e $GLOBAL ]]; then
		$SUDO ln -s $(realpath $LOCAL) $GLOBAL
	elif [[ -L $GLOBAL ]]; then
		$SUDO rm $GLOBAL
		$SUDO ln -s $(realpath $LOCAL) $GLOBAL
	fi
fi

exit 0
